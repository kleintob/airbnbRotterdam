---
title: 'Chapter 3: multiple regression'
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
# This chunk is for initial setup
knitr::opts_chunk$set(echo = TRUE)

# Function to check and install packages
check_install_package <- function(pkg) {
  if (!require(pkg, character.only = TRUE)) {
    install.packages(pkg)
    library(pkg, character.only = TRUE)
  }
}

# Check and install necessary packages
check_install_package("stargazer")
check_install_package("dplyr")

# Load necessary libraries
library(ggplot2)
library(dplyr)  # for data manipulation
```

We start again by loading the data.

```{r}
# Load the datasets from the RData file
load("../dataCreated/listings_clean.RData")

# Display the first few rows of the cleaned dataset
head(listings_clean)
```

Filter the data so that we use only listings for at most 6 people. From now on use this

```{r}
listings_clean_filtered <- listings_clean %>%
  filter(accommodates <= 6) 
```

We also create a variable `review_scores_rating_standardized` with the standardized review score. This helps with the interpretation.

```{r}
# Standardize review_scores_rating
listings_clean_filtered <- listings_clean_filtered %>%
  mutate(review_scores_rating_standardized = 
           (review_scores_rating - mean(review_scores_rating, na.rm = TRUE)) / 
           sd(review_scores_rating, na.rm = TRUE))
```

We still want to understand what prices depend on. We start with a simple model where we regress the log of the price on the standardized rating.

```{r}
model1 <- lm(log(price) ~ review_scores_rating_standardized, data = listings_clean_filtered)
summary(model1)
coef_model1 <- coef(model1)  # save coefficients
```

That says that for a place that has a rating that is one standard deviation higher we can expect to pay a price that is 2.3 percent higher.

However, we also recall that earlier, we have already found out that the price is highly correlated with how many people can stay in an apartment (we found a coefficient of 0.21 in a regression of log price on `accommodates'). So maybe that plays a role, too.

To find out, we carry out a multiple regression where we regress the log of the price on both the standardized rating and how many people can stay in it.

```{r}
model2 <- lm(log(price) ~ review_scores_rating_standardized + accommodates, data = listings_clean_filtered)
summary(model2)
coef_model2 <- coef(model2)  # save coefficients
```

This now shows that the predicted price increases even more when the standardized rating increases by one unit, about 4.6 percent. We also see that if one additional person can stay in a place, then we can expect a price that is about 21 percent higher per night (this is similar to what we found in the Chapter 2 analysis before when we regressed the log price on `accommodates').

To explain why the coefficient on `review_scores_rating_standardized` changes, we regress `accommodates` on `review_scores_rating_standardized`.

```{r}
model3 <- lm(accommodates ~ review_scores_rating_standardized, data = listings_clean_filtered)
summary(model3)
coef_model3 <- coef(model3)  # save coefficients
```

This shows that places with a better rating, on average, accommodate less people.

In the lecture, we have learned that from the results in `model2` and `model3`, we can reconstruct what we found in `model1`.

In `model1`, we look at the change in the predicted price when `review_scores_rating_standardized` changes by one unit (and there are no other variables in the model). In `model3`, we see that when `review_scores_rating_standardized` changes by one unit, then `accommodates` is predicted to change by -0.10587 units. But we know from `model2` that when `accommodates` changes by one unit, we predict the log price to be higher by 0.21285 units when we hold the rating fixed (ceteris paribus).

So, we can go from `model2` to `model1` by saying that the predicted change in the log price when the rating changes by one standard deviation is the ceteris paribus effect of a change in `review_scores_rating_standardized', 0.04554, plus how much we predict `accommodates` to change when `review_scores_rating_standardized` changes by one unit, -0.10587, times the ceteris paribus effect of `accommodates`, 0.21285.

Here is some R code that does this calculation:

```{r}
# Extract coefficients from model3 and model2
coef_rating_model2 <- coef(model2)["review_scores_rating_standardized"]
coef_accommodates_model2 <- coef(model2)["accommodates"]
coef_rating_model3 <- coef(model3)["review_scores_rating_standardized"]

# Calculate the desired value
result <- coef_rating_model2 + coef_rating_model3*coef_accommodates_model2

# Print the result
round(result,5)
```

This is the coefficient on `review_scores_rating_standardized` in `model1`.

Finally, we also make use of data on some neighborhood characteristics. These neighborhood characterstics were generated by chatGPT and are on a scale from 0 to 10. I've merged them with the web-scraped Airbnb data when I read in the data set. See build code for details.

Let's first look at some summary statistics.

```{r}
# Calculate means and standard deviations for the four variables
summary_stats <- listings_clean_filtered %>%
  summarise(
    Centrality_Mean = mean(Centrality, na.rm = TRUE),
    Centrality_SD = sd(Centrality, na.rm = TRUE),
    Quietness_Mean = mean(Quietness, na.rm = TRUE),
    Quietness_SD = sd(Quietness, na.rm = TRUE),
    Coolness_Mean = mean(Coolness, na.rm = TRUE),
    Coolness_SD = sd(Coolness, na.rm = TRUE),
    Fanciness_Mean = mean(Fanciness, na.rm = TRUE),
    Fanciness_SD = sd(Fanciness, na.rm = TRUE)
  )

# Reshape to have one column for means and another for standard deviations
summary_stats_tidy <- data.frame(
  Variable = c("Centrality", "Quietness", "Coolness", "Fanciness"),
  Mean = c(summary_stats$Centrality_Mean, summary_stats$Quietness_Mean, summary_stats$Coolness_Mean, summary_stats$Fanciness_Mean),
  SD = c(summary_stats$Centrality_SD, summary_stats$Quietness_SD, summary_stats$Coolness_SD, summary_stats$Fanciness_SD)
)

# Display the table
summary_stats_tidy
```

We estimate a richer model where we regress the log price on `review_scores_rating`, `accommodates`, and 4 neighborhood characteristics. 

```{r}
model4 <- lm(log(price) ~ review_scores_rating_standardized + accommodates + Centrality + Quietness + Coolness + Fanciness, data = listings_clean_filtered)
summary(model4)
```

This shows that prices are predicted to be higher when chatGPT rates the neighborhood more central, more quiet, more cool, and less fancy. This calls for more analysis.

As a first step, let's look at the list that has the highest value of `Fanciness`:

```{r}
# Get the top 10 unique neighborhoods with the highest Fanciness values
top_neighborhoods_unique <- listings_clean_filtered %>%
  distinct(neighbourhood_cleansed, .keep_all = TRUE) %>%
  arrange(desc(Fanciness)) %>%
  select(neighbourhood_cleansed, Fanciness) %>%
  head(10)

# Print the list
top_neighborhoods_unique
```

At this point, it's unclear why `Fanciness` should lead to lower predicted prices. Feel free to do some analysis and let me know if you find out what could explain this!

